<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Farmer Assistant - Dashboard</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container" id="app">
    <div class="header">
      <div class="h1">Farmer Assistant</div>
      <div id="user" class="small"></div>
    </div>

    <div id="home">
      <h3>Welcome</h3>
      <p class="small">Choose a tool below</p>
      <div class="big-icons">
        <div class="card" onclick="show('soil')">
          <div class="icon-large">üå±</div>
          <h4>Soil</h4>
          <div class="small">Analyze soil and get suggestions</div>
        </div>
        <div class="card" onclick="show('weather')">
          <div class="icon-large">‚òÅÔ∏è</div>
          <h4>Weather</h4>
          <div class="small">5-day forecast for your area</div>
        </div>
        <div class="card" onclick="show('disease')">
          <div class="icon-large">ü™¥</div>
          <h4>Disease</h4>
          <div class="small">Upload plant photo to detect disease</div>
        </div>
      </div>
    </div>

    <div id="soil" style="display:none">
      <button class="btn" onclick="back()">‚Üê Back</button>
      <h3>Soil Analyzer</h3>
      <div class="small">Enter soil test values (N, P, K in mg/kg; organic matter in %; pH)</div>
      <input id="crop" class="input" placeholder="Crop (e.g., tomato)">
      <select id="soil_type" class="input">
        <option value="red">Red</option>
        <option value="black">Black</option>
        <option value="yellow">Yellow</option>
        <option value="loamy">Loamy</option>
        <option value="alluvial">Alluvial</option>
      </select>
      <div class="row">
        <input id="nitrogen" class="input" placeholder="Nitrogen (N) mg/kg">
        <input id="phosphorus" class="input" placeholder="Phosphorus (P) mg/kg">
      </div>
      <div class="row">
        <input id="potassium" class="input" placeholder="Potassium (K) mg/kg">
        <input id="sulfur" class="input" placeholder="Sulfur (S) mg/kg">
      </div>
      <div class="row">
        <input id="organic_matter" class="input" placeholder="Organic matter (%)">
        <input id="ph" class="input" placeholder="pH">
      </div>
      <button class="btn" onclick="analyzeSoil()">Analyze</button>
      <div id="soilResult" class="result-card"></div>
    </div>

    <div id="weather" style="display:none">
      <button class="btn" onclick="back()">‚Üê Back</button>
      <h3>Weather Forecast</h3>
      <div class="small">Enter area name or use your location</div>
      <input id="city" class="input" placeholder="City / village name">
      <div style="margin:8px 0">
        <button class="btn" onclick="getWeatherByCity()">Get Weather</button>
        <button class="btn" onclick="useLocation()">Use My Location</button>
      </div>
      <div id="weatherResult" class="result-card"></div>
    </div>

    <div id="disease" style="display:none">
      <button class="btn" onclick="back()">‚Üê Back</button>
      <h3>Plant Disease Detection</h3>
      <div class="small">Upload a clear photo of the affected leaf/plant</div>
      <input type="file" id="plantImage" accept="image/*" class="input">
      <div style="margin-top:8px">
        <button class="btn" onclick="uploadDisease()">Detect Disease</button>
      </div>
      <div id="diseaseResult" class="result-card"></div>
    </div>

    <div class="footer">Made with ‚ù§Ô∏è for farmers</div>
  </div>

<script>
const userName = sessionStorage.getItem('farmer_name') || 'Farmer';
document.getElementById('user').innerText = userName;

function show(id){
  document.getElementById('home').style.display = 'none';
  ['soil','weather','disease'].forEach(x=> document.getElementById(x).style.display='none');
  document.getElementById(id).style.display = 'block';
}

function back(){
  document.getElementById('home').style.display = 'block';
  ['soil','weather','disease'].forEach(x=> document.getElementById(x).style.display='none');
}

// Soil analyze
async function analyzeSoil(){
  const payload = {
    crop: document.getElementById('crop').value,
    soil_type: document.getElementById('soil_type').value,
    nitrogen: document.getElementById('nitrogen').value,
    phosphorus: document.getElementById('phosphorus').value,
    potassium: document.getElementById('potassium').value,
    sulfur: document.getElementById('sulfur').value,
    organic_matter: document.getElementById('organic_matter').value,
    ph: document.getElementById('ph').value
  };
  const out = document.getElementById('soilResult');
  out.innerText = 'Analyzing...';
  try {
    const res = await fetch('/api/soil', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await res.json();
    renderSoil(data);
  } catch(e){
    out.innerText = 'Error: '+e.message;
  }
}

function renderSoil(data){
  const out = document.getElementById('soilResult');
  if (data.error){ out.innerText = data.error; return; }
  let html = `<strong>Crop:</strong> ${data.crop} <br><strong>Soil type:</strong> ${data.soil_type}<hr>`;
  for (const k of ['nitrogen','phosphorus','potassium','sulfur','organic_matter','ph']){
    const a = data.analysis[k];
    html += `<div><strong>${k.toUpperCase()}:</strong> ${a.value} ‚Äî <em>${a.status}</em><br>${a.suggestion}</div><hr>`;
  }
  out.innerHTML = html;
}

// Weather
async function getWeatherByCity(){
  const city = document.getElementById('city').value.trim();
  if (!city) return alert('Enter city name');
  const out = document.getElementById('weatherResult'); out.innerText = 'Loading...';
  try {
    const res = await fetch('/api/weather?q=' + encodeURIComponent(city));
    const data = await res.json();
    renderWeather(data);
  } catch(e){ out.innerText = 'Error: '+e.message; }
}

function renderWeather(data){
  const out = document.getElementById('weatherResult');
  if (data.error) { out.innerText = JSON.stringify(data); return; }
  const list = data.list || [];
  let html = `<strong>Location:</strong> ${data.city?.name || ''}, ${data.city?.country || ''}<hr>`;
  const days = {};
  list.forEach(item=>{
    const d = new Date(item.dt*1000).toLocaleDateString();
    days[d] = days[d] || [];
    days[d].push(item);
  });
  let count = 0;
  for (const day of Object.keys(days)){
    if (count>=5) break;
    const arr = days[day];
    const mid = arr[Math.floor(arr.length/2)];
    html += `<div><strong>${day}:</strong> ${mid.weather[0].main}, ${mid.main.temp}¬∞C, Hum ${mid.main.humidity}%</div>`;
    count++;
  }
  out.innerHTML = html;
}

// Geolocation
function useLocation(){
  if (!navigator.geolocation) return alert('Geolocation not supported');
  const out = document.getElementById('weatherResult'); out.innerText = 'Getting location...';
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    const res = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
    const data = await res.json();
    renderWeather(data);
  }, err=>{ alert('Location failed: '+err.message); });
}

// Disease upload
async function uploadDisease(){
  const file = document.getElementById('plantImage').files[0];
  if (!file) return alert('Please choose an image');
  const out = document.getElementById('diseaseResult'); out.innerText = 'Uploading...';
  const fd = new FormData();
  fd.append('image', file);
  try {
    const res = await fetch('/api/disease', { method: 'POST', body: fd });
    const data = await res.json();
    renderDisease(data);
  } catch(e){
    out.innerText = 'Error: ' + e.message;
  }
}

function renderDisease(data){
  const out = document.getElementById('diseaseResult');
  if (data.error) { out.innerText = 'Error: ' + data.error; return; }
  if (!data.result || !data.result.disease || !data.result.disease.suggestions) {
    out.innerText = 'No disease detected or invalid response';
    return;
  }
  const diseases = data.result.disease.suggestions;
  let html = '<strong>Disease Detection Results:</strong><hr>';
  diseases.forEach((disease, idx) => {
    const percent = (disease.probability * 100).toFixed(2);
    html += `<div><strong>${idx + 1}. ${disease.name}</strong><br>Probability: ${percent}%</div><hr>`;
  });
  out.innerHTML = html;
}
</script>
</body>
</html>
